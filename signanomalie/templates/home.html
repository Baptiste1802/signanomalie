{% extends "base.html" %}
{% block main %}
<h1 class="text-center">{{ title }}</h1>

<body>

    <div name="container1" class="container">
        <form action="" method="POST" class="needs-validation" novalidate>
            {{ form.hidden_tag() }}

            <div class="form-floating mb-3">
                {{ form.mail(class_="form-control") }}
                {{ form.mail.label(class_="form-label") }}
            </div>

            <div class="form-check form-switch">
                {{ form.mailDeSuivi(class_="form-check-input") }}
                {{ form.mailDeSuivi.label(class_="form-check-label") }}
            </div>

            <div class="mb-3">
                {{ form.batiment.label(class_="form-label") }}
                {{ form.batiment(class_="form-select") }}
            </div>

            <div class="mb-3">
                <div class="row">
                    <div class="col mb-3">
                        {{ form.salle.label(class_="form-label") }}
                        {{ form.salle(class_="form-select") }}
                    </div>

                    <div class="col mb-3">
                        {{ form.materiel.label(class_="form-label") }}
                        {{ form.materiel(class_="form-select")}}
                    </div>
                </div>
            </div>

            <div class="form-floating mb-3">
                {{ form.probleme(class_="form-control") }}
                {{ form.probleme.label(class_="form-label") }}
            </div>

            <div class="mb-3">
                {{ form.priorite.label(class_="form-label")}}
                {{ form.priorite(class_="form-select")}}
            </div>

            <div class="form-floating mb-3">
                {{ form.desc(class_="form-control") }}
                {{ form.desc.label(class_="form-label") }}
            </div>


            <div class="mb-3">
                <label for="formFile" class="ajoutphoto"><strong>Ajoutez une photo</strong></label>
                <input class="form-control" type="file" id="formFile">
            </div>

            <div class="boutons">
                <button type="submit" class="btn btn-primary" data-toggle="tooltip" data-placement="bottom" title="Valider et envoyer le ticket">Envoyer</button>
            
                <button type="reset" class="btn btn-primary" data-toggle="tooltip" data-placement="bottom" title="Remettre tous les champs Ã  vide">Reset</button>
            </div>
        
        </form>

        <script>
            let batiment_select = document.getElementById("batiment");
            let salle_select = document.getElementById("salle");
            let materiel_select = document.getElementById("materiel");
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            let batiment_input = urlParams.get('batiment');
            let salle_input = urlParams.get('salle');
            let materiel_input = urlParams.get('materiel');
            foundBat_input(batiment_input)
            

            function foundBat_input(batiment_input){
                for(let selector of document.getElementById("batiment")){
                    if(selector.value == batiment_input){
                        selector.setAttribute("selected",true)
                    }
                }
            }

            batiment_select.onchange = async function(){
                try
                {
                    
                    batiment = batiment_select.value;
                    const response = await fetch("/api/get/locations/" + batiment);
                    console.log(response.status)
                    if (!response.ok){
                        throw new Error(response.text)
                    }
                    const salles = await response.json();
                    let optionHTML = "";
                    for (let id in salles){
                        if((salle_input != null) && (salle_input == id)){
                            optionHTML += '<option value="'+ id + ' selected">' + salles[id] + '</option>'
                        }else{
                            optionHTML += '<option value="' + id + '">' + salles[id] + '</option>'; 
                        }
                    }
                    salle_select.innerHTML = optionHTML;
                }
                catch (error)
                {
                    console.error(error)
                }
            }

            salle_select.onchange = async function(){
                try
                {
                    salle = salle_select.value;
                    const response = await fetch("/api/get/computers/" + salle);
                    console.log(response.status)
                    if (!response.ok){
                        throw new Error(response.text)
                    }
                    const computers = await response.json();
                    let optionHTML = "";
                    for (let id in computers){
                        if((materiel_input != null) && (materiel_input == id)){
                            optionHTML += '<option value="'+ id + ' selected">' + computers[id] + '</option>'
                        }else{
                            optionHTML += '<option value="' + id + '">' + computers[id] + '</option>'; 
                        }
                    }
                    materiel_select.innerHTML = optionHTML;
                }
                catch (error)
                {
                    console.error(error)
                }
            }

        </script>
    </div>

</body>
{% endblock %}